<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZORIN | Pro Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Syncopate:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #050505; --card: #111; --border: #222; --accent: #fff; --red: #ff4444; --green: #00ff88; }
        body { margin: 0; font-family: 'Cairo', sans-serif; background: var(--bg); color: #fff; display: none; }
        
        .dashboard { display: grid; grid-template-columns: 250px 1fr; min-height: 100vh; }
        
        /* Sidebar */
        aside { background: #000; border-left: 1px solid var(--border); padding: 40px 20px; display: flex; flex-direction: column; }
        aside h2 { font-family: 'Syncopate'; font-size: 1.2rem; margin-bottom: 50px; text-align: center; letter-spacing: 5px; }
        .menu-btn { width: 100%; padding: 15px; background: none; border: none; color: #666; text-align: right; cursor: pointer; font-size: 1rem; transition: 0.3s; margin-bottom: 5px; }
        .menu-btn.active { color: #fff; border-right: 3px solid #fff; background: #111; }

        /* Main Content */
        main { padding: 40px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; }
        h3 { font-family: 'Syncopate'; margin-bottom: 30px; font-size: 1.5rem; }

        /* Forms & Inventory Table */
        .card { background: var(--card); border: 1px solid var(--border); padding: 25px; margin-bottom: 30px; border-radius: 8px; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; background: #000; border: 1px solid var(--border); color: #fff; box-sizing: border-box; }
        .btn-main { background: #fff; color: #000; border: none; padding: 15px; font-weight: bold; cursor: pointer; width: 100%; border-radius: 4px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: right; color: #666; padding: 15px; border-bottom: 1px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .prod-img-sm { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .status-badge { padding: 4px 10px; font-size: 0.7rem; border-radius: 12px; }
        .status-in { background: rgba(0, 255, 136, 0.1); color: var(--green); }
        .status-out { background: rgba(255, 68, 68, 0.1); color: var(--red); }

        /* Orders */
        .order-item { background: var(--card); padding: 18px; margin-bottom: 10px; border-right: 4px solid #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; }
        
        /* Modal Pop-up */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: #111; padding: 40px; border: 1px solid var(--border); width: 450px; border-radius: 8px; position: relative; }
        .close-btn { position: absolute; top: 15px; left: 15px; cursor: pointer; color: #666; font-size: 1.5rem; }
    </style>
</head>
<body>

    <div class="dashboard">
        <aside>
            <h2>ZORIN</h2>
            <button class="menu-btn active" onclick="showTab('add-tab', this)"><i class="fas fa-plus"></i> إضافة منتج</button>
            <button class="menu-btn" onclick="showTab('inventory-tab', this)"><i class="fas fa-box"></i> المخزن</button>
            <button class="menu-btn" onclick="showTab('orders-tab', this)"><i class="fas fa-shopping-bag"></i> الطلبات</button>
            <button class="menu-btn" onclick="handleLogout()" style="margin-top:auto; color:var(--red)"><i class="fas fa-sign-out-alt"></i> خروج</button>
        </aside>

        <main>
            <section id="add-tab" class="section active">
                <h3>NEW ITEM</h3>
                <div class="card">
                    <input type="text" id="pName" placeholder="اسم المنتج">
                    <input type="number" id="pPrice" placeholder="السعر">
                    <input type="number" id="pStock" placeholder="الكمية المتاحة (عدد القطع)">
                    <textarea id="pDesc" placeholder="الوصف والخامة"></textarea>
                    <p style="font-size:0.8rem; color:#666">ارفع 4 صور للمنتج:</p>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input type="file" id="img1"> <input type="file" id="img2">
                        <input type="file" id="img3"> <input type="file" id="img4">
                    </div>
                    <button class="btn-main" id="upBtn" onclick="saveProduct()">حفظ ونشر</button>
                </div>
            </section>

            <section id="inventory-tab" class="section">
                <h3>INVENTORY</h3>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>الصورة</th>
                                <th>الاسم</th>
                                <th>الكمية</th>
                                <th>الحالة</th>
                                <th>التحكم</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryList"></tbody>
                    </table>
                </div>
            </section>

            <section id="orders-tab" class="section">
                <h3>ORDERS</h3>
                <div id="ordersList"></div>
            </section>
        </main>
    </div>

    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="orderNumTitle" style="font-family:'Syncopate'"></h2>
            <hr style="border:0; border-top:1px solid #222; margin:20px 0;">
            <p><strong>المنتج:</strong> <span id="mProd"></span></p>
            <p><strong>العميل:</strong> <span id="mCust"></span></p>
            <p><strong>التليفون:</strong> <span id="mPhone"></span></p>
            <p><strong>العنوان:</strong> <span id="mAddr"></span></p>
            <button class="btn-main" style="margin-top:20px;" onclick="closeModal()">تمت المراجعة</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCInkKv1hByxRZiHbOAfRn9bGbmaAPoZ8A",
            authDomain: "mystore-842cf.firebaseapp.com",
            projectId: "mystore-842cf",
            storageBucket: "mystore-842cf.firebasestorage.app",
            messagingSenderId: "594163229640",
            appId: "1:594163229640:web:888670dd4016e8111656fd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === "zorin@gmail.com") {
                document.body.style.display = 'block';
                loadInventory(); loadOrders();
            } else { window.location.href = 'index.html'; }
        });

        window.showTab = (tabId, btn) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        };

        // رفع صور متعددة
        async function uploadAll(files) {
            const urls = [];
            for(const f of files) {
                if(f) {
                    const fd = new FormData(); fd.append('file', f); fd.append('upload_preset', 'ftnc2dkd');
                    const res = await fetch(`https://api.cloudinary.com/v1_1/dv9zvesyp/image/upload`, {method:'POST', body:fd});
                    const d = await res.json(); urls.push(d.secure_url);
                }
            }
            return urls;
        }

        window.saveProduct = async () => {
            const btn = document.getElementById('upBtn');
            btn.innerText = "جاري الرفع..."; btn.disabled = true;
            const files = [document.getElementById('img1').files[0], document.getElementById('img2').files[0], document.getElementById('img3').files[0], document.getElementById('img4').files[0]];
            const gallery = await uploadAll(files);
            
            await addDoc(collection(db, "products"), {
                name: document.getElementById('pName').value,
                price: document.getElementById('pPrice').value,
                stock: parseInt(document.getElementById('pStock').value),
                description: document.getElementById('pDesc').value,
                image: gallery[0], gallery: gallery, createdAt: new Date()
            });
            alert("تم النشر!"); location.reload();
        };

        function loadInventory() {
            onSnapshot(query(collection(db, "products"), orderBy("createdAt", "desc")), (snap) => {
                const list = document.getElementById('inventoryList');
                list.innerHTML = "";
                snap.forEach(d => {
                    const p = d.data();
                    const status = p.stock > 0 ? `<span class="status-badge status-in">In Stock</span>` : `<span class="status-badge status-out">Sold Out</span>`;
                    list.innerHTML += `
                        <tr>
                            <td><img src="${p.image}" class="prod-img-sm"></td>
                            <td>${p.name}</td>
                            <td>${p.stock} قطعة</td>
                            <td>${status}</td>
                            <td>
                                <button onclick="editStock('${d.id}')" style="color:var(--green); background:none; border:none; cursor:pointer;"><i class="fas fa-edit"></i></button>
                                <button onclick="delProd('${d.id}')" style="color:var(--red); background:none; border:none; cursor:pointer; margin-right:10px;"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                });
            });
        }

        window.editStock = async (id) => {
            const n = prompt("ادخل الكمية الجديدة المتوفرة:");
            if(n !== null) await updateDoc(doc(db, "products", id), { stock: parseInt(n) });
        };

        window.delProd = async (id) => { if(confirm("حذف المنتج؟")) await deleteDoc(doc(db, "products", id)); };

        function loadOrders() {
            onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snap) => {
                const list = document.getElementById('ordersList');
                list.innerHTML = "";
                let count = snap.size;
                snap.forEach(d => {
                    const o = d.data();
                    list.innerHTML += `
                        <div class="order-item" onclick="openOrder('${o.customerName}', '${o.productName}', '${o.customerPhone}', '${o.address}', ${count})">
                            <span>#${count--} طلب جديد: ${o.customerName}</span>
                            <i class="fas fa-eye"></i>
                        </div>`;
                });
            });
        }

        window.openOrder = (name, prod, phone, addr, id) => {
            document.getElementById('orderNumTitle').innerText = "طلب رقم #" + id;
            document.getElementById('mProd').innerText = prod;
            document.getElementById('mCust').innerText = name;
            document.getElementById('mPhone').innerText = phone;
            document.getElementById('mAddr').innerText = addr;
            document.getElementById('orderModal').style.display = 'flex';
        };

        window.closeModal = () => document.getElementById('orderModal').style.display = 'none';
        window.handleLogout = () => signOut(auth).then(() => window.location.href = 'index.html');
    </script>
</body>
</html>